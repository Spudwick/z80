#===============================================================================================================================================================
# Include build system components.
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
include build-sys/build-sources.mk
include build-sys/build-tools.mk
include build-sys/build-dirs.mk
#===============================================================================================================================================================

#===============================================================================================================================================================
# Check to insure user specified at least one module.
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
ifeq ($(MODULES),)
$(error ERROR: No Module Specified! Usage is 'make MODULES="<module1> [module2] [...]" [clean|build|cbuild|print]')
endif
#===============================================================================================================================================================

#===============================================================================================================================================================
# Include makefiles for specified modules.
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
TGTS := $(subst ;, ,$(MODULES))
$(foreach FL,$(MODULES),$(eval include $(FL)/$(notdir $(FL)).mk))
#===============================================================================================================================================================

#===============================================================================================================================================================
# Include the memory map file containing segment address.
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
include mem_map.mk
#===============================================================================================================================================================

VERB := @

.PHONY : all build print clean cbuild $(CLN_TRGS)

.DEFAULT_GOAL := cbuild

#===============================================================================================================================================================
# Rule : print
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Prints useful debug information on currently selected modules.
#===============================================================================================================================================================
print :
	@echo MODULES   = $(REG_MODS)
	@echo ----------------------------------------------------------------------------------
	@echo LIBS      = $(MOD_LIBS)
	@echo ----------------------------------------------------------------------------------
	@echo SRCS_C    = $(notdir $(SRCS_C))
	@echo SRCS_S    = $(notdir $(SRCS_S))
	@echo ASMS      = $(notdir $(ASMS))
	@echo OBJS      = $(notdir $(OBJS))	
	@echo ----------------------------------------------------------------------------------
	@echo IHX File  = $(IHEX)
	@echo BIN File  = $(BIN)
	@echo LIB File  = $(LIB)
#===============================================================================================================================================================

all : print cbuild

cbuild : clean build

build : $(BIN) $(LIB)

clean : $(CLN_TRGS)

#===============================================================================================================================================================
# Rule : clean-%
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Base rule for cleaning individual directories. These rules are generated when adding a new module.
#===============================================================================================================================================================
$(CLN_TRGS) : clean-% :
	@echo Cleaning $(subst clean-,,$(subst @,:,$@))...
	$(VERB)$(call RM_DIR,$(subst clean-,,$(subst @,:,$@)))
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : %.c
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Rule for building .c files.
#===============================================================================================================================================================
%.c :
	@echo Preprocessing $<...
	$(VERB)$(call MK_DIR,$(dir $@))
	$(VERB)$(CPP) $(CPPFLAGS) -isystem/usr/share/sdcc/include $(addprefix -isystem,$(call GET_LIBINCS)) $(addprefix -I,$(call GET_MODINCS)) -o $@ $<
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : %.s
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Rule for building .s files.
#===============================================================================================================================================================
%.s :
	@echo Compiling $<...
	$(VERB)$(call MK_DIR,$(dir $@))
	$(VERB)$(CC) $(CCFLAGS) --codeseg $(call GET_SRCAREA,$<) -o $@ $<
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : %.rel
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Rule for building .rel files.
#===============================================================================================================================================================	
%.rel :
	@echo Assembling $<...
	$(VERB)$(call MK_DIR,$(dir $@))
	$(VERB)$(ASM) $(ASMFLAGS) $@ $<
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : %.ihx
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Rule for building .ihx files.
#===============================================================================================================================================================
%.ihx : $(OBJS)
	@echo Linking $@...
	$(VERB)$(call MK_DIR,$(dir $@))
	$(VERB)$(LNK) $(LNKFLAGS) $(foreach SEG,$(SEGS),-b _$(SEG)=$(SEG_$(SEG))) $(addprefix -k ,$(call GET_SYSLIBDIRS)) $(addprefix -k ,$(call GET_LIBDIRS)) $(addprefix -l ,$(call GET_SYSLIBS)) $(addprefix -l ,$(call GET_LIBS)) -i $@ $^
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : %.lib
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Rule for building .lib files.
#===============================================================================================================================================================
%.lib : $(OBJS)
	@echo Generating Library $@...
	$(VERB)$(CLIB) $@ $^
	@echo --------------------------------------------------------------------------------------
	@echo Library File available at $@
#===============================================================================================================================================================
	
#===============================================================================================================================================================
# Rule : $(BIN)
#---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Absolute rule for building Bianry file from iHex file.
#===============================================================================================================================================================
$(BIN) : $(IHEX)
	@echo Converting $@...
	$(VERB)$(call MK_DIR,$(dir $@))
ifeq ($(OS),Windows_NT)
	$(VERB)$(BIN_CP) $@ $<
	$(VERB)$(call CP,$(<:%.ihx=%.bin),$@)
	$(VERB)$(call RM_FILE,$(<:%.ihx=%.bin))
else
	$(VERB)$(BIN_CP) $< $@
endif
	@echo --------------------------------------------------------------------------------------
	@echo Binary File available at $@
#===============================================================================================================================================================
